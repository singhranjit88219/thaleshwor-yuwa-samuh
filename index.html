<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thaleshwor Yuwa Samuh</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

  <style>
    :root { --primary:#0d6efd; --success:#198754; --danger:#dc3545; --warning:#ffc107; --info:#0dcaf0; }
    body { background:#f8f9fa; font-family:'Segoe UI',sans-serif; }
    .sidebar { position:fixed; top:0; left:0; height:100vh; width:260px; background:#2c3e50; color:#fff; padding-top:20px; z-index:1000; }
    .sidebar .nav-link { color:#bdc3c7; padding:12px 20px; border-radius:8px; margin:4px 15px; transition:all .2s; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { background:#34495e; color:#fff; }
    .sidebar .nav-link i { width:24px; }
    .main-content { margin-left:260px; padding:20px; }
    .stat-card { border-radius:12px; padding:16px; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .stat-card h5 { font-size:0.9rem; opacity:0.9; margin:0; }
    .stat-card p { font-size:1.7rem; font-weight:700; margin:8px 0 0; }
    .card { border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.07); }
    .card-header { border-radius:12px 12px 0 0; font-weight:600; }
    .table th { font-weight:600; color:#495057; }
    .badge { font-size:0.8rem; }
    .hidden { display:none !important; }
    #errorMsg { background:#ffebee; color:#c62828; padding:12px; border-radius:8px; margin:1rem 0; }
    .search-input { max-width:300px; }
    .chart-container { position:relative; height:300px; }
    .user-info { position:fixed; bottom:20px; left:20px; background:#2c3e50; color:#fff; padding:10px 16px; border-radius:50px; font-size:0.9rem; }
  </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="text-center mb-4">
    <h4><i class="bi bi-bank"></i> Thaleshwor Yuwa Samuh</h4>
  </div>
  <nav class="nav flex-column">
    <a class="nav-link active" href="#" onclick="showPage('dashboard')"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a class="nav-link" href="#" onclick="showPage('members')"><i class="bi bi-people"></i> Members</a>
    <a class="nav-link" href="#" onclick="showPage('savings')"><i class="bi bi-piggy-bank"></i> Savings</a>
    <a class="nav-link" href="#" onclick="showPage('loans')"><i class="bi bi-cash-stack"></i> Loans</a>
    <a class="nav-link" href="#" onclick="showPage('payments')"><i class="bi bi-receipt"></i> Payments</a>
  </nav>
</div>

<!-- User Info -->
<div class="user-info">
  <i class="bi bi-person-circle"></i> <span id="currentUser">Guest</span>
  <button class="btn btn-sm btn-outline-light ms-2" onclick="logout()">Logout</button>
</div>

<!-- Main Content -->
<div class="main-content">

  <!-- Login -->
  <div id="loginPage" class="card mx-auto p-4" style="max-width:420px; margin-top:10vh;">
    <h3 class="text-center mb-4"><i class="bi bi-box-arrow-in-right"></i> Login</h3>
    <div class="mb-3">
      <label class="form-label">Username</label>
      <input id="username" class="form-control" placeholder="admin or user">
    </div>
    <div class="mb-3">
      <label class="form-label">Password</label>
      <input id="password" type="password" class="form-control">
    </div>
    <button onclick="login()" class="btn btn-primary w-100">Login</button>
    <p id="loginMsg" class="text-danger text-center mt-2"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboardPage" class="hidden">
    <h2>Dashboard</h2>
    <p class="text-muted">Cooperative Microfinance Overview</p>
    <div class="row g-3 mb-4">
      <div class="col-md-3"><div class="stat-card bg-primary"><h5>Total Members</h5><p id="dashMembers">0</p></div></div>
      <div class="col-md-3"><div class="stat-card bg-success"><h5>Total Savings</h5><p id="dashSavings">0</p></div></div>
      <div class="col-md-3"><div class="stat-card bg-warning text-dark"><h5>Active Loans</h5><p id="dashLoans">0</p></div></div>
      <div class="col-md-3"><div class="stat-card bg-info"><h5>Growth Rate</h5><p id="dashGrowth">0%</p></div></div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-success text-white">Savings & Loans Growth</div>
          <div class="card-body"><div class="chart-container"><canvas id="growthChart"></canvas></div></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-warning text-dark">Loan Distribution (Top 5)</div>
          <div class="card-body"><div class="chart-container"><canvas id="loanPie"></canvas></div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-danger text-white">Monthly Defaulters</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Savings Defaulters</h6>
            <p id="savingDefaulters">0 members who haven't paid this month</p>
          </div>
          <div class="col-md-6">
            <h6>Loan Interest Defaulters</h6>
            <p id="interestDefaulters">0 loans without interest payment this month</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Members -->
  <div id="membersPage" class="hidden">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2>Members</h2>
        <p class="text-muted">Manage cooperative members</p>
      </div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#memberModal" onclick="clearMemberForm()">+ Add Member</button>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-3">
          <p>All Members (<span id="memberCount">0</span>)</p>
          <input type="text" class="form-control search-input" placeholder="Search members..." onkeyup="searchMembers(this.value)">
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Member ID</th><th>Name</th><th>Phone</th><th>Join Date</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="membersTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Savings -->
  <div id="savingsPage" class="hidden">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2>Monthly Savings</h2>
        <p class="text-muted">Track member savings contributions</p>
      </div>
      <button class="btn btn-success" onclick="showSavingForm()">+ Record Saving</button>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-3">
          <p>Savings Records (<span id="savingCount">0</span>)</p>
          <input type="text" class="form-control search-input" placeholder="Search by member..." onkeyup="searchSavings(this.value)">
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Member</th><th>Amount</th><th>Month</th><th>Payment Date</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="savingsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Loans -->
  <div id="loansPage" class="hidden">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2>Loans</h2>
        <p class="text-muted">Manage member loans and distributions</p>
      </div>
      <button class="btn btn-warning" onclick="showLoanForm()">+ Distribute Loan</button>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-3">
          <p>All Loans (<span id="loanCount">0</span>)</p>
          <input type="text" class="form-control search-input" placeholder="Search by member..." onkeyup="searchLoans(this.value)">
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Member</th><th>Principal</th><th>Balance</th><th>Interest Rate</th><th>Monthly Interest</th><th>Loan Date</th><th>Duration</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="loansTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Payments -->
  <div id="paymentsPage" class="hidden">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2>Loan Payments</h2>
        <p class="text-muted">Track monthly interest and principal payments</p>
      </div>
      <button class="btn btn-info" onclick="payInterest()">+ Record Payment</button>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-3">
          <p>Payment Records (<span id="paymentCount">0</span>)</p>
          <input type="text" class="form-control search-input" placeholder="Search by member..." onkeyup="searchPayments(this.value)">
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Member</th><th>Payment Month</th><th>Interest Paid</th><th>Principal Paid</th><th>Total Paid</th><th>Payment Date</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="paymentsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <p id="errorMsg" class="hidden"></p>
</div>

<!-- Member Modal -->
<div class="modal fade" id="memberModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>Add / Edit Member</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="editMemberId">
        <div class="mb-3"><label>Name</label><input id="memberName" class="form-control"></div>
        <div class="mb-3"><label>Phone</label><input id="memberPhone" class="form-control"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-primary" onclick="saveMember()">Save</button></div>
    </div>
  </div>
</div>

<!-- Forms -->
<div id="savingForm" class="hidden card mt-4">
  <div class="card-header bg-success text-white">Record Monthly Saving</div>
  <div class="card-body">
    <select id="savingMember" class="form-select mb-3"></select>
    <input type="month" id="savingMonth" class="form-control mb-3">
    <input type="number" id="savingAmount" class="form-control mb-3" placeholder="Amount">
    <button class="btn btn-success me-2" onclick="saveSaving()">Save</button>
    <button class="btn btn-secondary" onclick="hideSavingForm()">Cancel</button>
  </div>
</div>

<div id="loanForm" class="hidden card mt-4">
  <div class="card-header bg-warning text-dark">Distribute Loan</div>
  <div class="card-body">
    <select id="loanMember" class="form-select mb-3"></select>
    <input type="number" id="loanPrincipal" class="form-control mb-3" placeholder="Principal">
    <input type="number" step="0.01" id="loanRate" class="form-control mb-3" placeholder="Annual Interest Rate %">
    <input type="date" id="loanDate" class="form-control mb-3">
    <input type="number" id="loanDuration" class="form-control mb-3" placeholder="Duration (months)">
    <button class="btn btn-success me-2" onclick="saveLoan()">Save</button>
    <button class="btn btn-secondary" onclick="hideLoanForm()">Cancel</button>
  </div>
</div>

<script>
  // ---------- YOUR FIREBASE CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBSTXmDJTX5DyO85KR62Rcx4zzlLPP7_u0",
    authDomain: "thaleshwor-yuwa-samuh.firebaseapp.com",
    projectId: "thaleshwor-yuwa-samuh",
    storageBucket: "thaleshwor-yuwa-samuh.firebasestorage.app",
    messagingSenderId: "372716860859",
    appId: "1:372716860859:web:40de331870a5e4de5b409e",
    measurementId: "G-SPEN77HFE2"
  };
  // -----------------------------------------

  let db, isAdmin = false;
  let members = [], savings = [], loans = [], payments = [];

  try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); }
  catch (e) { showError('Firebase failed: ' + e.message); }

  function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    if (u === 'admin' && p === 'samuh2082') { isAdmin = true; startApp('dashboard'); }
    else if (u === 'user' && p === 'password') { isAdmin = false; startApp('dashboard'); }
    else document.getElementById('loginMsg').textContent = 'Wrong credentials';
  }

  function startApp(page) {
    document.getElementById('loginPage').classList.add('hidden');
    document.querySelectorAll('.main-content > div:not(#loginPage)').forEach(el => el.classList.add('hidden'));
    document.getElementById(page + 'Page').classList.remove('hidden');
    document.getElementById('currentUser').textContent = isAdmin ? 'admin' : 'viewer';
    updateNavActive(page);
    if (db) loadData();
  }

  function logout() {
    document.getElementById('loginPage').classList.remove('hidden');
    document.querySelectorAll('.main-content > div:not(#loginPage)').forEach(el => el.classList.add('hidden'));
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }

  function showPage(page) {
    document.querySelectorAll('.main-content > div[id$="Page"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(page + 'Page').classList.remove('hidden');
    updateNavActive(page);
    if (page === 'members') renderMembers();
    else if (page === 'savings') renderSavings();
    else if (page === 'loans') renderLoans();
    else if (page === 'payments') renderPayments();
    else renderDashboard();
  }

  function updateNavActive(page) {
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
      link.classList.remove('active');
      if (link.onclick.toString().includes(page)) link.classList.add('active');
    });
  }

  async function loadData() {
    try {
      const [m,s,l,p] = await Promise.all([
        db.collection('members').get(),
        db.collection('savings').get(),
        db.collection('loans').get(),
        db.collection('payments').get()
      ]);
      members = m.docs.map(d=>({id:d.id,...d.data()}));
      savings = s.docs.map(d=>({id:d.id,...d.data()}));
      loans   = l.docs.map(d=>({id:d.id,...d.data()}));
      payments= p.docs.map(d=>({id:d.id,...d.data()}));
      renderDashboard();
    } catch (e) { showError('Load failed: '+e.message); }
  }

  function renderDashboard() {
    const totalM = members.length;
    const totalS = savings.reduce((a,b)=>a+b.amount,0);
    const totalL = loans.filter(l=>l.status!=='closed').reduce((a,b)=>a+b.principal,0);
    const growth = calculateGrowth();
    document.getElementById('dashMembers').textContent = totalM;
    document.getElementById('dashSavings').textContent = 'Rs.' + totalS.toFixed(0);
    document.getElementById('dashLoans').textContent = 'Rs.' + totalL.toFixed(0);
    document.getElementById('dashGrowth').textContent = growth.toFixed(0) + '%';

    // Growth Chart
    const months = [], savData = [], loanData = [];
    for(let i=5; i>=0; i--){
      const d = new Date(); d.setMonth(d.getMonth()-i);
      const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      months.push(m.split('-')[1] + '/' + m.split('-')[0].slice(2));
      savData.push(savings.filter(x=>x.month===m).reduce((a,b)=>a+b.amount,0));
      loanData.push(loans.filter(x=>x.startDate<=m && x.status!=='closed').reduce((a,b)=>a+b.principal,0));
    }
    if(window.growthChart) window.growthChart.destroy();
    window.growthChart = new Chart(document.getElementById('growthChart'),{
      type:'line', data:{labels:months, datasets:[
        {label:'Savings', data:savData, borderColor:'#198754', backgroundColor:'rgba(25,135,84,.1)', fill:true},
        {label:'Loans', data:loanData, borderColor:'#ffc107', backgroundColor:'rgba(255,193,7,.1)', fill:true}
      ]}, options:{responsive:true}
    });

    // Loan Pie
    const pieLabels = [], pieData = [];
    members.slice(0,5).forEach(m=>{
      const amt = loans.filter(l=>l.memberId===m.id && l.status!=='closed').reduce((a,b)=>a+b.principal,0);
      if(amt>0){ pieLabels.push(m.name); pieData.push(amt); }
    });
    if(window.loanPie) window.loanPie.destroy();
    window.loanPie = new Chart(document.getElementById('loanPie'),{
      type:'doughnut', data:{labels:pieLabels, datasets:[{data:pieData, backgroundColor:['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1']}]},
      options:{responsive:true}
    });

    // Defaulters
    const cur = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
    const savDef = members.filter(m=>!savings.some(s=>s.memberId===m.id && s.month===cur)).length;
    const intDef = loans.filter(l=>l.status!=='closed' && !payments.some(p=>p.loanId===l.id && p.month===cur)).length;
    document.getElementById('savingDefaulters').textContent = savDef + ' members who haven\'t paid this month';
    document.getElementById('interestDefaulters').textContent = intDef + ' loans without interest payment this month';
  }

  function calculateGrowth() {
    const now = new Date();
    const cur = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const prev = `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
    const curSav = savings.filter(x=>x.month===cur).reduce((a,b)=>a+b.amount,0);
    const prevSav = savings.filter(x=>x.month===prev).reduce((a,b)=>a+b.amount,0);
    return prevSav === 0 ? 0 : ((curSav - prevSav) / prevSav) * 100;
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg; el.classList.remove('hidden');
  }

  // ---------- Members ----------
  function renderMembers() {
    const tbody = document.getElementById('membersTable');
    tbody.innerHTML = '';
    members.forEach(m => {
      const id = 'M' + String(members.indexOf(m) + 1).padStart(3, '0');
      tbody.innerHTML += `<tr>
        <td>${id}</td>
        <td>${m.name}</td>
        <td>${m.phone || '-'}</td>
        <td>${m.joinDate || 'Sep 10, 2025'}</td>
        <td><span class="badge ${m.status==='active'?'bg-success':'bg-secondary'}">${m.status||'Active'}</span></td>
        <td>
          ${isAdmin ? `<button class="btn btn-sm btn-outline-primary" onclick="editMember('${m.id}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteMember('${m.id}')"><i class="bi bi-trash"></i></button>` : ''}
        </td>
      </tr>`;
    });
    document.getElementById('memberCount').textContent = members.length;
  }

  function editMember(id) {
    const m = members.find(x=>x.id===id);
    document.getElementById('editMemberId').value = id;
    document.getElementById('memberName').value = m.name;
    document.getElementById('memberPhone').value = m.phone || '';
    new bootstrap.Modal(document.getElementById('memberModal')).show();
  }

  function clearMemberForm() {
    document.getElementById('editMemberId').value = '';
    document.getElementById('memberName').value = '';
    document.getElementById('memberPhone').value = '';
  }

  async function saveMember() {
    const id = document.getElementById('editMemberId').value;
    const data = { name: document.getElementById('memberName').value.trim(), phone: document.getElementById('memberPhone').value.trim(), joinDate: new Date().toISOString().split('T')[0] };
    if (!data.name) return alert('Name required');
    try {
      id ? await db.collection('members').doc(id).update(data) : await db.collection('members').add(data);
      bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
      loadData();
    } catch (e) { alert(e.message); }
  }

  async function deleteMember(id) {
    if (confirm('Delete member?')) {
      try { await db.collection('members').doc(id).delete(); loadData(); }
      catch (e) { alert(e.message); }
    }
  }

  function searchMembers(q) {
    const rows = document.querySelectorAll('#membersTable tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(q.toLowerCase()) ? '' : 'none';
    });
  }

  // ---------- Savings ----------
  function showSavingForm() { document.getElementById('savingForm').classList.remove('hidden'); fillMemberSelect('savingMember'); }
  function hideSavingForm() { document.getElementById('savingForm').classList.add('hidden'); }
  async function saveSaving() {
    const memberId = document.getElementById('savingMember').value;
    const month = document.getElementById('savingMonth').value;
    const amount = parseFloat(document.getElementById('savingAmount').value);
    if (!memberId || !month || isNaN(amount)) return alert('Fill all');
    try {
      await db.collection('savings').add({ memberId, month, amount, paymentDate: new Date().toISOString().split('T')[0] });
      hideSavingForm(); loadData();
    } catch (e) { alert(e.message); }
  }

  function renderSavings() {
    const tbody = document.getElementById('savingsTable');
    tbody.innerHTML = '';
    savings.forEach(s => {
      const m = members.find(x=>x.id===s.memberId);
      tbody.innerHTML += `<tr>
        <td>${m?.name || 'Unknown'}</td>
        <td>Rs.${s.amount}</td>
        <td>${s.month}</td>
        <td>${s.paymentDate || '-'}</td>
        <td><span class="badge bg-success">Paid</span></td>
        <td>${isAdmin ? `<button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>` : ''}</td>
      </tr>`;
    });
    document.getElementById('savingCount').textContent = savings.length;
  }

  function searchSavings(q) {
    const rows = document.querySelectorAll('#savingsTable tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(q.toLowerCase()) ? '' : 'none';
    });
  }

  // ---------- Loans ----------
  function showLoanForm() { document.getElementById('loanForm').classList.remove('hidden'); fillMemberSelect('loanMember'); }
  function hideLoanForm() { document.getElementById('loanForm').classList.add('hidden'); }
  async function saveLoan() {
    const memberId = document.getElementById('loanMember').value;
    const principal = parseFloat(document.getElementById('loanPrincipal').value);
    const rate = parseFloat(document.getElementById('loanRate').value);
    const start = document.getElementById('loanDate').value;
    const duration = parseInt(document.getElementById('loanDuration').value);
    if (!memberId || isNaN(principal) || isNaN(rate) || !start || isNaN(duration)) return alert('Fill all');
    try {
      await db.collection('loans').add({ memberId, principal, balance: principal, rate, startDate: start, duration, status: 'active' });
      hideLoanForm(); loadData();
    } catch (e) { alert(e.message); }
  }

  function renderLoans() {
    const tbody = document.getElementById('loansTable');
    tbody.innerHTML = '';
    loans.forEach(l => {
      const m = members.find(x=>x.id===l.memberId);
      const monthlyInt = l.principal * (l.rate/100) / 12;
      tbody.innerHTML += `<tr>
        <td>${m?.name || 'Unknown'}</td>
        <td>Rs.${l.principal}</td>
        <td>Rs.${l.balance}</td>
        <td>${l.rate}%</td>
        <td>Rs.${monthlyInt.toFixed(2)}</td>
        <td>${l.startDate}</td>
        <td>${l.duration} months</td>
        <td><span class="badge bg-warning">Active</span></td>
        <td>${isAdmin ? `<button class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger ms-1"><i class="bi bi-trash"></i></button>` : ''}</td>
      </tr>`;
    });
    document.getElementById('loanCount').textContent = loans.length;
  }

  function searchLoans(q) {
    const rows = document.querySelectorAll('#loansTable tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(q.toLowerCase()) ? '' : 'none';
    });
  }

  // ---------- Payments ----------
  async function payInterest() {
    const cur = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
    let total = 0;
    const due = [];
    loans.filter(l=>l.status!=='closed').forEach(l => {
      const paid = payments.some(p=>p.loanId===l.id && p.month===cur);
      if (!paid) {
        const int = l.principal * (l.rate/100) / 12;
        total += int;
        due.push({loanId: l.id, amount: int, month: cur, paymentDate: new Date().toISOString().split('T')[0]});
      }
    });
    if (total === 0) return alert('No interest due');
    if (confirm(`Pay Rs.${total.toFixed(2)} interest?`)) {
      try {
        for (const d of due) await db.collection('payments').add(d);
        alert('Payment recorded!');
        loadData();
      } catch (e) { alert(e.message); }
    }
  }

  function renderPayments() {
    const tbody = document.getElementById('paymentsTable');
    tbody.innerHTML = '';
    payments.forEach(p => {
      const l = loans.find(x=>x.id===p.loanId);
      const m = members.find(x=>x.id===l?.memberId);
      tbody.innerHTML += `<tr>
        <td>${m?.name || 'Unknown'}</td>
        <td>${p.month}</td>
        <td>Rs.${p.amount}</td>
        <td>Rs.0</td>
        <td>Rs.${p.amount}</td>
        <td>${p.paymentDate}</td>
        <td><span class="badge bg-success">Paid</span></td>
        <td>${isAdmin ? `<button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>` : ''}</td>
      </tr>`;
    });
    document.getElementById('paymentCount').textContent = payments.length;
  }

  function searchPayments(q) {
    const rows = document.querySelectorAll('#paymentsTable tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(q.toLowerCase()) ? '' : 'none';
    });
  }

  function fillMemberSelect(id) {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">Select Member</option>';
    members.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.name}</option>`);
  }

  // Bootstrap JS
  const bs = document.createElement('script');
  bs.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
  document.body.appendChild(bs);
</script>

</body>
</html>
