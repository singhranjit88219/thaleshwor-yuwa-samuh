<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thaleshwor Yuwa Samuh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBSTXmDJTX5DyO85KR62Rcx4zzlLPP7_u0",
      authDomain: "thaleshwor-yuwa-samuh.firebaseapp.com",
      projectId: "thaleshwor-yuwa-samuh",
      storageBucket: "thaleshwor-yuwa-samuh.firebasestorage.app",
      messagingSenderId: "372716860859",
      appId: "1:372716860859:web:40de331870a5e4de5b409e",
      measurementId: "G-SPEN77HFE2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    window.firebaseReady = true;
    window.firebase = { db, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, auth, provider, signInWithPopup, signOut, onAuthStateChanged };
  </script>

  <style>
    .hidden { display: none !important; }
    .sidebar { width: 220px; }
    .main-content { margin-left: 220px; }
    @media (max-width: 768px) { .sidebar, .main-content { width: 100%; margin: 0; } }
    .chart-container { height: 300px; }
  </style>
</head>
<body class="bg-light">

<div class="sidebar bg-white shadow-sm position-fixed h-100 p-3">
  <h5 class="text-center mb-4">Thaleshwor Yuwa Samuh</h5>
  <ul class="nav nav-pills flex-column">
    <li class="nav-item"><a class="nav-link active" href="#" onclick="showPage('dashboard')">Dashboard</a></li>
    <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('members')">Members</a></li>
    <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('savings')">Savings</a></li>
    <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('loans')">Loans</a></li>
    <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('payments')">Payments</a></li>
    <li class="nav-item mt-4"><a class="nav-link text-danger" href="#" onclick="logout()">Logout</a></li>
  </ul>
  <div class="mt-auto text-center text-muted small">
    Logged in as: <span id="currentUser">Guest</span>
  </div>
</div>

<div class="main-content p-4">

  <!-- LOGIN PAGE - ALWAYS VISIBLE FIRST -->
  <div id="loginPage" class="container">
    <div class="row justify-content-center mt-5">
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-body text-center p-5">
            <h2 class="mb-4">Welcome to Thaleshwor Yuwa Samuh</h2>
            <p class="text-muted mb-4">Sign in with Google to access the dashboard</p>
            <button id="googleSignInBtn" class="btn btn-primary btn-lg w-100">
              <i class="bi bi-google me-2"></i>
              Sign in with Google
            </button>
            <div id="loginStatus" class="mt-3 text-muted"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD PAGE -->
  <div id="dashboardPage" class="hidden container">
    <h2>Dashboard</h2>
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 id="dashMembers">0</h5>
            <p class="card-text">Total Members</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 id="dashSavings">Rs. 0</h5>
            <p class="card-text">Total Savings</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 id="dashLoans">Rs. 0</h5>
            <p class="card-text">Active Loans</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 id="dashGrowth">0%</h5>
            <p class="card-text">Monthly Growth</p>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">Savings vs Loans (Last 6 Months)</div>
          <div class="card-body">
            <canvas id="growthChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">Top Loan Holders</div>
          <div class="card-body">
            <canvas id="loanPie"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MEMBERS PAGE -->
  <div id="membersPage" class="hidden container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Members <span class="badge bg-primary" id="memberCount">0</span></h2>
      <button id="addMemberBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#memberModal" onclick="clearMemberForm()">
        <i class="bi bi-plus"></i> Add Member
      </button>
    </div>
    <input type="text" class="form-control mb-3 w-25" placeholder="Search members..." onkeyup="searchMembers(this.value)">
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Join Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="membersTable">
          <tr>
            <td colspan="7" class="text-center text-muted">
              <div class="spinner-border spinner-border-sm" role="status"></div>
              <span class="ms-2">Loading members...</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- SAVINGS PAGE (Example - Add similar for Loans & Payments) -->
  <div id="savingsPage" class="hidden container">
    <h2>Savings <span class="badge bg-primary" id="savingCount">0</span></h2>
    <table class="table table-striped">
      <tbody id="savingsTable">
        <tr><td colspan="6" class="text-center">Loading savings...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- MEMBER MODAL -->
<div class="modal fade" id="memberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add / Edit Member</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editMemberId">
        <div class="mb-3">
          <label class="form-label">Name <span class="text-danger">*</span></label>
          <input type="text" id="memberName" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Phone</label>
          <input type="text" id="memberPhone" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Address</label>
          <input type="text" id="memberAddress" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Join Date <span class="text-danger">*</span></label>
          <input type="date" id="memberJoinDate" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveMemberBtn" onclick="saveMember()">
          <span class="spinner-border spinner-border-sm me-2 hidden" id="saveSpinner"></span>
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Initialize app when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    let user = null;
    let isAdmin = false;
    let members = [];

    // Wait for Firebase to be ready
    const initApp = async () => {
      if (!window.firebaseReady) {
        setTimeout(initApp, 100);
        return;
      }

      const { auth, provider, signInWithPopup, signOut, onAuthStateChanged, db, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } = window.firebase;

      // Set up Google button
      document.getElementById('googleSignInBtn').onclick = () => {
        signInWithPopup(auth, provider).catch(e => {
          document.getElementById('loginStatus').innerHTML = `<div class="alert alert-danger">Login failed: ${e.message}</div>`;
        });
      };

      // Listen for auth changes
      onAuthStateChanged(auth, async (u) => {
        user = u;
        if (user) {
          // Check if admin (via custom claim)
          const token = await user.getIdTokenResult();
          isAdmin = token.claims.role === 'admin';

          document.getElementById('currentUser').textContent = user.displayName + (isAdmin ? ' (Admin)' : ' (Viewer)');
          document.getElementById('loginPage').classList.add('hidden');
          document.getElementById('dashboardPage').classList.remove('hidden');
          document.getElementById('addMemberBtn').style.display = isAdmin ? 'inline-block' : 'none';
          loadMembers();
        } else {
          document.getElementById('loginPage').classList.remove('hidden');
          document.querySelectorAll('.main-content > div[id$="Page"]').forEach(el => el.classList.add('hidden'));
          document.getElementById('currentUser').textContent = 'Guest';
        }
      });
    };

    initApp();

    window.logout = () => signOut(auth);

    window.showPage = (page) => {
      document.querySelectorAll('.main-content > div[id$="Page"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(page + 'Page').classList.remove('hidden');
      if (page === 'members') loadMembers();
    };

    // Load Members
    window.loadMembers = async () => {
      try {
        const snap = await getDocs(collection(db, 'members'));
        members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMembers();
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('membersTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Load failed: ' + e.message + '</td></tr>';
      }
    };

    function renderMembers() {
      const tbody = document.getElementById('membersTable');
      tbody.innerHTML = '';
      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No members yet. Add one to start!</td></tr>';
        return;
      }
      members.forEach((m, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>M${String(i + 1).padStart(3, '0')}</td>
          <td>${m.name}</td>
          <td>${m.phone || '-'}</td>
          <td>${m.address || '-'}</td>
          <td>${m.joinDate}</td>
          <td><span class="badge bg-success">Active</span></td>
          <td>
            ${isAdmin ? `
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editMember('${m.id}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${m.id}')">
                <i class="bi bi-trash"></i>
              </button>
            ` : '<span class="text-muted">View only</span>'}
          </td>
        `;
        tbody.appendChild(row);
      });
      document.getElementById('memberCount').textContent = members.length;
    }

    // Save Member
    window.saveMember = async () => {
      if (!isAdmin) {
        alert('Only admins can add/edit members');
        return;
      }

      const id = document.getElementById('editMemberId').value;
      const name = document.getElementById('memberName').value.trim();
      const joinDate = document.getElementById('memberJoinDate').value;

      if (!name || !joinDate) {
        alert('Name and Join Date are required');
        return;
      }

      const data = {
        name,
        phone: document.getElementById('memberPhone').value.trim(),
        address: document.getElementById('memberAddress').value.trim(),
        joinDate
      };

      const spinner = document.getElementById('saveSpinner');
      spinner.classList.remove('hidden');
      const btn = document.getElementById('saveMemberBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Saving...';
      btn.disabled = true;

      try {
        if (id) {
          await updateDoc(doc(db, 'members', id), data);
        } else {
          await addDoc(collection(db, 'members'), data);
        }
        loadMembers();
        bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
        alert('Member saved successfully!');
      } catch (e) {
        alert('Save failed: ' + e.message + '\n\nCheck Firebase Rules if permission error.');
      } finally {
        spinner.classList.add('hidden');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    };

    window.editMember = (id) => {
      if (!isAdmin) return;
      const m = members.find(x => x.id === id);
      if (!m) return alert('Member not found');
      document.getElementById('editMemberId').value = id;
      document.getElementById('memberName').value = m.name;
      document.getElementById('memberPhone').value = m.phone || '';
      document.getElementById('memberAddress').value = m.address || '';
      document.getElementById('memberJoinDate').value = m.joinDate;
      new bootstrap.Modal(document.getElementById('memberModal')).show();
    };

    window.clearMemberForm = () => {
      document.getElementById('editMemberId').value = '';
      document.getElementById('memberName').value = '';
      document.getElementById('memberPhone').value = '';
      document.getElementById('memberAddress').value = '';
      document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
    };

    window.deleteMember = async (id) => {
      if (!isAdmin) return;
      if (confirm('Delete this member?')) {
        try {
          await deleteDoc(doc(db, 'members', id));
          loadMembers();
          alert('Member deleted');
        } catch (e) {
          alert('Delete failed: ' + e.message);
        }
      }
    };

    window.searchMembers = (q) => {
      const rows = document.querySelectorAll('#membersTable tr');
      rows.forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
      });
    };
  });
</script>

</body>
</html>
