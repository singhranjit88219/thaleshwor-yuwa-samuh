<script>
  // ---------- FIREBASE ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBSTXmDJTX5DyO85KR62Rcx4zzlLPP7_u0",
    authDomain: "thaleshwor-yuwa-samuh.firebaseapp.com",
    projectId: "thaleshwor-yuwa-samuh",
    storageBucket: "thaleshwor-yuwa-samuh.firebasestorage.app",
    messagingSenderId: "372716860859",
    appId: "1:372716860859:web:40de331870a5e4de5b409e",
    measurementId: "G-SPEN77HFE2"
  };

  let db, isAdmin = false;
  let members = [], savings = [], loans = [], payments = [];
  let growthChart = null, loanPie = null;
  let loading = false;  // NEW: Prevent multiple loads

  try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); }
  catch (e) { showError('Firebase init failed: ' + e.message); }

  // ---------- AUTH ----------
  function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    if (u === 'admin' && p === 'samuh2082') { isAdmin = true; startApp('dashboard'); }
    else if (u === 'user' && p === 'password') { isAdmin = false; startApp('dashboard'); }
    else document.getElementById('loginMsg').textContent = 'Wrong credentials';
  }

  function startApp(page) {
    document.getElementById('loginPage').classList.add('hidden');
    document.querySelectorAll('.main-content > div:not(#loginPage)').forEach(el => el.classList.add('hidden'));
    document.getElementById(page + 'Page').classList.remove('hidden');
    document.getElementById('currentUser').textContent = isAdmin ? 'admin' : 'viewer';
    updateNavActive(page);
    if (!loading) loadData();  // NEW: Prevent double load
  }

  function logout() {
    document.getElementById('loginPage').classList.remove('hidden');
    document.querySelectorAll('.main-content > div:not(#loginPage)').forEach(el => el.classList.add('hidden'));
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }

  // ---------- NAV ----------
  function showPage(page) {
    if (growthChart) { growthChart.destroy(); growthChart = null; }
    if (loanPie) { loanPie.destroy(); loanPie = null; }

    document.querySelectorAll('.main-content > div[id$="Page"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(page + 'Page').classList.remove('hidden');
    updateNavActive(page);

    if (page === 'dashboard') renderDashboard();
    else if (page === 'members') renderMembers();
    else if (page === 'savings') renderSavings();
    else if (page === 'loans') renderLoans();
    else if (page === 'payments') renderPayments();
  }

  function updateNavActive(page) {
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
      link.classList.remove('active');
      if (link.onclick.toString().includes(page)) link.classList.add('active');
    });
  }

  // ---------- DATA ----------
  async function loadData() {
    if (loading) return;  // NEW: Prevent multiple simultaneous loads
    loading = true;
    try {
      const [m,s,l,p] = await Promise.all([
        db.collection('members').get(),
        db.collection('savings').get(),
        db.collection('loans').get(),
        db.collection('payments').get()
      ]);
      members = m.docs.map(d => ({id: d.id, ...d.data()}));
      savings = s.docs.map(d => ({id: d.id, ...d.data()}));
      loans = l.docs.map(d => ({id: d.id, ...d.data()}));
      payments = p.docs.map(d => ({id: d.id, ...d.data()}));

      if (!document.getElementById('dashboardPage').classList.contains('hidden')) renderDashboard();
    } catch (e) { showError('Load failed: ' + e.message); } finally {
      loading = false;  // NEW: Reset loading
    }
  }

  // ---------- DASHBOARD ----------
  function renderDashboard() {
    const totalM = members.length;
    const totalS = savings.reduce((a,b) => a + (b.amount || 0), 0);
    const totalL = loans.filter(l => l.status !== 'closed').reduce((a,b) => a + (b.principal || 0), 0);
    const growth = calculateGrowth();

    document.getElementById('dashMembers').textContent = totalM;
    document.getElementById('dashSavings').textContent = 'Rs.' + totalS.toFixed(0);
    document.getElementById('dashLoans').textContent = 'Rs.' + totalL.toFixed(0);
    document.getElementById('dashGrowth').textContent = growth.toFixed(0) + '%';

    const months = [], savData = [], loanData = [];
    for (let i = 5; i >= 0; i--) {
      const d = new Date(); d.setMonth(d.getMonth() - i);
      const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      months.push(m.split('-')[1] + '/' + m.split('-')[0].slice(2));
      savData.push(savings.filter(x => x.month === m).reduce((a,b) => a + b.amount, 0));
      loanData.push(loans.filter(x => x.startDate <= m && x.status !== 'closed').reduce((a,b) => a + b.principal, 0));
    }

    if (growthChart) growthChart.destroy();
    growthChart = new Chart(document.getElementById('growthChart'), {
      type: 'line',
      data: { labels: months, datasets: [
        { label: 'Savings', data: savData, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,.1)', fill: true },
        { label: 'Loans', data: loanData, borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,.1)', fill: true }
      ]},
      options: { responsive: true }
    });

    const pieLabels = [], pieData = [];
    members.slice(0,5).forEach(m => {
      const amt = loans.filter(l => l.memberId === m.id && l.status !== 'closed').reduce((a,b) => a + b.principal, 0);
      if (amt > 0) { pieLabels.push(m.name); pieData.push(amt); }
    });

    if (loanPie) loanPie.destroy();
    loanPie = new Chart(document.getElementById('loanPie'), {
      type: 'doughnut',
      data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1'] }] },
      options: { responsive: true }
    });

    const cur = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
    const savDef = members.filter(m => !savings.some(s => s.memberId === m.id && s.month === cur)).length;
    const intDef = loans.filter(l => l.status !== 'closed' && !payments.some(p => p.loanId === l.id && p.month === cur)).length;
    document.getElementById('savingDefaulters').textContent = savDef + ' members who haven\'t paid this month';
    document.getElementById('interestDefaulters').textContent = intDef + ' loans without interest payment this month';
  }

  function calculateGrowth() {
    const now = new Date();
    const cur = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const prev = `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
    const curSav = savings.filter(x => x.month === cur).reduce((a,b) => a + b.amount, 0);
    const prevSav = savings.filter(x => x.month === prev).reduce((a,b) => a + b.amount, 0);
    return prevSav === 0 ? 0 : ((curSav - prevSav) / prevSav) * 100;
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000);
  }

  // ---------- MEMBERS ----------
  function renderMembers() {
    const tbody = document.getElementById('membersTable');
    tbody.innerHTML = '';
    members.forEach((m, i) => {
      const id = 'M' + String(i + 1).padStart(3, '0');
      tbody.innerHTML += `<tr>
        <td>${id}</td>
        <td>${m.name}</td>
        <td>${m.phone || '-'}</td>
        <td>${m.address || '-'}</td>
        <td>${m.joinDate || '-'}</td>
        <td><span class="badge bg-success">Active</span></td>
        <td>${isAdmin ? `<button class="btn btn-sm btn-outline-primary" onclick="editMember('${m.id}')"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteMember('${m.id}')"><i class="bi bi-trash"></i></button>` : ''}</td>
      </tr>`;
    });
    document.getElementById('memberCount').textContent = members.length;
  }

  function editMember(id) {
    const m = members.find(x => x.id === id);
    document.getElementById('editMemberId').value = id;
    document.getElementById('memberName').value = m.name;
    document.getElementById('memberPhone').value = m.phone || '';
    document.getElementById('memberAddress').value = m.address || '';
    document.getElementById('memberJoinDate').value = m.joinDate || '';
    new bootstrap.Modal(document.getElementById('memberModal')).show();
  }

  function clearMemberForm() {
    document.getElementById('editMemberId').value = '';
    document.getElementById('memberName').value = '';
    document.getElementById('memberPhone').value = '';
    document.getElementById('memberAddress').value = '';
    document.getElementById('memberJoinDate').value = new Date().toISOString().split('T')[0];
  }

  async function saveMember() {
    const id = document.getElementById('editMemberId').value;
    const name = document.getElementById('memberName').value.trim();
    const phone = document.getElementById('memberPhone').value.trim();
    const address = document.getElementById('memberAddress').value.trim();
    const joinDate = document.getElementById('memberJoinDate').value;

    if (!name || !joinDate) return alert('Name and Join Date required');

    const data = { name, phone, address, joinDate };
    try {
      if (id) await db.collection('members').doc(id).update(data);
      else await db.collection('members').add(data);
      bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
      loadData();
      showPage('members');
    } catch (e) { alert(e.message); }
  }

  async function deleteMember(id) {
    if (confirm('Delete member?')) {
      try { await db.collection('members').doc(id).delete(); loadData(); showPage('members'); }
      catch (e) { alert(e.message); }
    }
  }

  function searchMembers(q) {
    const rows = document.querySelectorAll('#membersTable tr');
    rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none');
  }

  // ---------- SAVINGS ----------
  const savingModal = new bootstrap.Modal(document.getElementById('savingModal'));
  document.getElementById('savingModal').addEventListener('show.bs.modal', () => {
    fillMemberSelect('savingMemberModal');
    document.getElementById('savingMonthModal').value = new Date().toISOString().slice(0,7);
    document.getElementById('savingAmountModal').value = '';
  });

  async function saveSavingModal() {
    const memberId = document.getElementById('savingMemberModal').value;
    const month = document.getElementById('savingMonthModal').value;
    const amount = parseFloat(document.getElementById('savingAmountModal').value);
    if (!memberId || !month || isNaN(amount)) return alert('Fill all fields');
    try {
      await db.collection('savings').add({ memberId, month, amount, paymentDate: new Date().toISOString().split('T')[0] });
      savingModal.hide();
      loadData();
      showPage('savings');
    } catch (e) { alert(e.message); }
  }

  function renderSavings() {
    const tbody = document.getElementById('savingsTable');
    tbody.innerHTML = '';
    savings.forEach(s => {
      const m = members.find(x => x.id === s.memberId);
      tbody.innerHTML += `<tr>
        <td>${m?.name || 'Unknown'}</td>
        <td>Rs.${s.amount}</td>
        <td>${s.month}</td>
        <td>${s.paymentDate || '-'}</td>
        <td><span class="badge bg-success">Paid</span></td>
        <td>${isAdmin ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteSaving('${s.id}')"><i class="bi bi-trash"></i></button>` : ''}</td>
      </tr>`;
    });
    document.getElementById('savingCount').textContent = savings.length;
  }

  async function deleteSaving(id) {
    if (confirm('Delete saving record?')) {
      try { await db.collection('savings').doc(id).delete(); loadData(); showPage('savings'); }
      catch (e) { alert(e.message); }
    }
  }

  function searchSavings(q) {
    const rows = document.querySelectorAll('#savingsTable tr');
    rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none');
  }

  // ---------- LOANS ----------
  const loanModal = new bootstrap.Modal(document.getElementById('loanModal'));
  document.getElementById('loanModal').addEventListener('show.bs.modal', () => {
    fillMemberSelect('loanMemberModal');
    document.getElementById('loanDateModal').value = new Date().toISOString().split('T')[0];
    document.getElementById('loanPrincipalModal').value = '';
    document.getElementById('loanRateModal').value = '';
    document.getElementById('loanDurationModal').value = '';
  });

  async function saveLoanModal() {
    const memberId = document.getElementById('loanMemberModal').value;
    const principal = parseFloat(document.getElementById('loanPrincipalModal').value);
    const rate = parseFloat(document.getElementById('loanRateModal').value);
    const start = document.getElementById('loanDateModal').value;
    const duration = parseInt(document.getElementById('loanDurationModal').value);
    if (!memberId || isNaN(principal) || isNaN(rate) || !start || isNaN(duration)) return alert('Fill all fields');
    try {
      await db.collection('loans').add({ memberId, principal, balance: principal, rate, startDate: start, duration, status: 'active' });
      loanModal.hide();
      loadData();
      showPage('loans');
    } catch (e) { alert(e.message); }
  }

  function renderLoans() {
    const tbody = document.getElementById('loansTable');
    tbody.innerHTML = '';
    loans.forEach(l => {
      const m = members.find(x => x.id === l.memberId);
      const monthlyInt = (l.principal * (l.rate / 100) / 12).toFixed(2);
      tbody.innerHTML += `<tr>
        <td>${m?.name || 'Unknown'}</td>
        <td>Rs.${l.principal}</td>
        <td>Rs.${l.balance}</td>
        <td>${l.rate}%</td>
        <td>Rs.${monthlyInt}</td>
        <td>${l.startDate}</td>
        <td>${l.duration} months</td>
        <td><span class="badge bg-warning">Active</span></td>
        <td>${isAdmin ? `<button class="btn btn-sm btn-outline-primary" onclick="editLoan('${l.id}')"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteLoan('${l.id}')"><i class="bi bi-trash"></i></button>` : ''}</td>
      </tr>`;
    });
    document.getElementById('loanCount').textContent = loans.length;
  }

  async function deleteLoan(id) {
    if (confirm('Delete loan?')) {
      try { await db.collection('loans').doc(id).delete(); loadData(); showPage('loans'); }
      catch (e) { alert(e.message); }
    }
  }

  function searchLoans(q) {
    const rows = document.querySelectorAll('#loansTable tr');
    rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none');
  }

  // ---------- PAYMENTS ----------
  async function payInterest() {
    const cur = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
    let total = 0;
    const due = [];
    loans.filter(l => l.status !== 'closed').forEach(l => {
      if (!payments.some(p => p.loanId === l.id && p.month === cur)) {
        const int = l.principal * (l.rate/100) / 12;
        total += int;
        due.push({ loanId: l.id, amount: int, month: cur, paymentDate: new Date().toISOString().split('T')[0] });
      }
    });
    if (total === 0) return alert('No interest due');
    if (confirm(`Pay Rs.${total.toFixed(2)} interest?`)) {
      try {
        for (const d of due) await db.collection('payments').add(d);
        alert('Payment recorded!');
        loadData();
        showPage('payments');
      } catch (e) { alert(e.message); }
    }
  }

  function renderPayments() {
    const tbody = document.getElementById('paymentsTable');
    tbody.innerHTML = '';
    payments.forEach(p => {
      const l = loans.find(x => x.id === p.loanId);
      const m = members.find(x => x.id === l?.memberId);
      tbody.innerHTML += `<tr>
        <td>${m?.name || 'Unknown'}</td>
        <td>${p.month}</td>
        <td>Rs.${p.amount.toFixed(2)}</td>
        <td>Rs.0</td>
        <td>Rs.${p.amount.toFixed(2)}</td>
        <td>${p.paymentDate}</td>
        <td><span class="badge bg-success">Paid</span></td>
        <td>${isAdmin ? `<button class="btn btn-sm btn-outline-danger" onclick="deletePayment('${p.id}')"><i class="bi bi-trash"></i></button>` : ''}</td>
      </tr>`;
    });
    document.getElementById('paymentCount').textContent = payments.length;
  }

  async function deletePayment(id) {
    if (confirm('Delete payment?')) {
      try { await db.collection('payments').doc(id).delete(); loadData(); showPage('payments'); }
      catch (e) { alert(e.message); }
    }
  }

  function searchPayments(q) {
    const rows = document.querySelectorAll('#paymentsTable tr');
    rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none');
  }

  function fillMemberSelect(id) {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">Select Member</option>';
    members.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.name}</option>`);
  }

  // Load Bootstrap
  const bs = document.createElement('script');
  bs.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
  document.body.appendChild(bs);
</script>
