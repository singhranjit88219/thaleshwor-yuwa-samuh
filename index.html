<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thaleshwor Yuwa Samuh</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
  <style>
    body { padding-top: 20px; }
    .card { margin-bottom: 15px; }
    .hidden { display: none; }
    .defaulter { color: red; }
    #errorMsg { color: red; text-align: center; margin: 10px; }
  </style>
</head>
<body class="container">

<h1 class="text-center mb-4">Thaleshwor Yuwa Samuh</h1>

<!-- ==================== LOGIN ==================== -->
<div id="loginSection" class="card p-4 mx-auto" style="max-width:400px;">
  <h3 class="text-center">Login</h3>
  <div class="mb-3">
    <label class="form-label">Username</label>
    <input id="username" class="form-control" placeholder="admin or user">
  </div>
  <div class="mb-3">
    <label class="form-label">Password</label>
    <input id="password" type="password" class="form-control" placeholder="password">
  </div>
  <button onclick="login()" class="btn btn-primary w-100">Login</button>
  <p id="loginMsg" class="text-danger mt-2"></p>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="appSection" class="hidden">

  <!-- Dashboard -->
  <div id="dashboard" class="row">
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>Members</h5><p id="totalMembers">0</p></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>Total Saving</h5><p id="totalSaving">0</p></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>Total Loan</h5><p id="totalLoan">0</p></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>Growth %</h5><p id="growthRate">0</p></div></div></div>
  </div>

  <div class="row">
    <div class="col-md-6"><canvas id="savingChart"></canvas></div>
    <div class="col-md-6"><canvas id="loanPie"></canvas></div>
  </div>

  <h4 class="mt-4">Defaulters (Current Month)</h4>
  <div id="defaulters"></div>

  <!-- Admin Controls -->
  <div id="adminControls" class="hidden mt-4">
    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#memberModal">Add Member</button>
    <button class="btn btn-info me-2" onclick="showSavingForm()">Add Saving</button>
    <button class="btn btn-warning me-2" onclick="showLoanForm()">Add Loan</button>
    <button class="btn btn-danger me-2" onclick="payInterest()">Pay Interest</button>
  </div>

  <!-- Members Table -->
  <h4 class="mt-4">Members</h4>
  <table class="table table-striped">
    <thead><tr><th>Name</th><th>Phone</th><th>Saving</th><th>Loan</th><th>Action</th></tr></thead>
    <tbody id="memberTable"></tbody>
  </table>
</div>

<p id="errorMsg" class="hidden"></p>

<!-- ==================== MODALS ==================== -->
<div class="modal fade" id="memberModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>Add / Edit Member</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="mb-3"><label>Name</label><input id="mName" class="form-control"></div>
        <div class="mb-3"><label>Phone</label><input id="mPhone" class="form-control"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveMember()">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="savingForm" class="hidden card p-3 mt-3">
  <h5>Add Monthly Saving</h5>
  <select id="sMember" class="form-select mb-2"></select>
  <input type="month" id="sMonth" class="form-control mb-2">
  <input type="number" id="sAmount" class="form-control mb-2" placeholder="Amount">
  <button class="btn btn-success" onclick="saveSaving()">Save</button>
  <button class="btn btn-secondary ms-2" onclick="hideSavingForm()">Cancel</button>
</div>

<div id="loanForm" class="hidden card p-3 mt-3">
  <h5>Add Loan</h5>
  <select id="lMember" class="form-select mb-2"></select>
  <input type="number" id="lPrincipal" class="form-control mb-2" placeholder="Principal">
  <input type="number" step="0.01" id="lRate" class="form-control mb-2" placeholder="Annual Rate %">
  <input type="date" id="lStart" class="form-control mb-2">
  <button class="btn btn-success" onclick="saveLoan()">Save</button>
  <button class="btn btn-secondary ms-2" onclick="hideLoanForm()">Cancel</button>
</div>

<script>
  // ---------- YOUR FIREBASE CONFIG (already inserted) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBSTXmDJTX5DyO85KR62Rcx4zzlLPP7_u0",
    authDomain: "thaleshwor-yuwa-samuh.firebaseapp.com",
    projectId: "thaleshwor-yuwa-samuh",
    storageBucket: "thaleshwor-yuwa-samuh.firebasestorage.app",
    messagingSenderId: "372716860859",
    appId: "1:372716860859:web:40de331870a5e4de5b409e",
    measurementId: "G-SPEN77HFE2"
  };
  // -----------------------------------------------------------

  let db;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  } catch (e) {
    showError('Firebase init error: ' + e.message);
  }

  let isAdmin = false;
  let members = [], savings = [], loans = [], payments = [];

  // ---------- Login ----------
  function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    if (u === 'admin' && p === 'samuh2082') { isAdmin = true; startApp(); }
    else if (u === 'user' && p === 'password') { isAdmin = false; startApp(); }
    else { document.getElementById('loginMsg').textContent = 'Wrong credentials'; }
  }

  function startApp() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('appSection').classList.remove('hidden');
    document.getElementById('adminControls').classList.toggle('hidden', !isAdmin);
    if (db) loadData();
    else showError('Database not ready.');
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.remove('hidden');
  }

  // ---------- Load Data ----------
  async function loadData() {
    try {
      const [m, s, l, p] = await Promise.all([
        db.collection('members').get(),
        db.collection('savings').get(),
        db.collection('loans').get(),
        db.collection('payments').get()
      ]);
      members = m.docs.map(d => ({id: d.id, ...d.data()}));
      savings = s.docs.map(d => ({id: d.id, ...d.data()}));
      loans   = l.docs.map(d => ({id: d.id, ...d.data()}));
      payments= p.docs.map(d => ({id: d.id, ...d.data()}));
      renderAll();
    } catch (e) { showError('Load error: ' + e.message); }
  }

  // ---------- Render ----------
  function renderAll() {
    renderMembers(); renderDashboard(); renderCharts(); renderDefaulters(); fillSelects();
  }

  function renderMembers() {
    const tbody = document.getElementById('memberTable');
    tbody.innerHTML = '';
    members.forEach(m => {
      const sav = savings.filter(x=>x.memberId===m.id).reduce((a,b)=>a+b.amount,0);
      const ln  = loans.filter(x=>x.memberId===m.id && x.status!=='closed').reduce((a,b)=>a+b.principal,0);
      tbody.innerHTML += `<tr>
        <td>${m.name}</td><td>${m.phone}</td><td>${sav.toFixed(2)}</td><td>${ln.toFixed(2)}</td>
        <td>${isAdmin?`<button class="btn btn-sm btn-primary" onclick="editMember('${m.id}')">Edit</button>
        <button class="btn btn-sm btn-danger ms-1" onclick="deleteMember('${m.id}')">Del</button>`:''}</td>
      </tr>`;
    });
  }

  function renderDashboard() {
    const totalM = members.length;
    const totalS = savings.reduce((a,b)=>a+b.amount,0);
    const totalL = loans.filter(x=>x.status!=='closed').reduce((a,b)=>a+b.principal,0);
    const growth = calculateGrowth();
    document.getElementById('totalMembers').textContent = totalM;
    document.getElementById('totalSaving').textContent   = totalS.toFixed(2);
    document.getElementById('totalLoan').textContent     = totalL.toFixed(2);
    document.getElementById('growthRate').textContent    = growth.toFixed(2)+'%';
  }

  function calculateGrowth() {
    const now = new Date();
    const cur = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const prev= `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
    const curSav = savings.filter(x=>x.month===cur).reduce((a,b)=>a+b.amount,0);
    const prevSav= savings.filter(x=>x.month===prev).reduce((a,b)=>a+b.amount,0);
    return prevSav===0 ? 0 : ((curSav-prevSav)/prevSav)*100;
  }

  let savingChart, loanPie;
  function renderCharts() {
    // Saving line (last 6 months)
    const months=[], data=[];
    for(let i=5;i>=0;i--){
      const d=new Date(); d.setMonth(d.getMonth()-i);
      const m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      months.push(m);
      data.push(savings.filter(x=>x.month===m).reduce((a,b)=>a+b.amount,0));
    }
    if(savingChart) savingChart.destroy();
    savingChart = new Chart(document.getElementById('savingChart'),{
      type:'line', data:{labels:months,datasets:[{label:'Savings',data,borderColor:'green',fill:false}]}
    });

    // Loan pie
    const labels=[], vals=[];
    members.forEach(m=>{
      const amt=loans.filter(x=>x.memberId===m.id && x.status!=='closed').reduce((a,b)=>a+b.principal,0);
      if(amt>0){labels.push(m.name); vals.push(amt);}
    });
    if(loanPie) loanPie.destroy();
    loanPie = new Chart(document.getElementById('loanPie'),{
      type:'pie', data:{labels,datasets:[{data:vals,backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF']}]}
    });
  }

  function renderDefaulters() {
    const now=new Date();
    const cur=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    let html='<h5>Saving Defaulters</h5><ul>';
    members.forEach(m=>{ if(!savings.some(x=>x.memberId===m.id && x.month===cur)) html+=`<li class="defaulter">${m.name} (Saving)</li>`; });
    html+='</ul><h5>Interest Defaulters</h5><ul>';
    loans.filter(l=>l.status!=='closed').forEach(l=>{
      const mem=members.find(m=>m.id===l.memberId);
      if(!mem) return;
      const dueMonth = getDueMonth(l.startDate);
      const paid = payments.some(p=>p.loanId===l.id && p.month===dueMonth);
      if(dueMonth===cur && !paid) html+=`<li class="defaulter">${mem.name} (Interest)</li>`;
    });
    html+='</ul>';
    document.getElementById('defaulters').innerHTML = html || '<p>No defaulters.</p>';
  }

  function getDueMonth(start){
    const s=new Date(start);
    const n=new Date();
    return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
  }

  // ---------- Admin ----------
  function editMember(id){
    const m=members.find(x=>x.id===id);
    if(!m) return;
    document.getElementById('editId').value=id;
    document.getElementById('mName').value=m.name;
    document.getElementById('mPhone').value=m.phone;
    new bootstrap.Modal(document.getElementById('memberModal')).show();
  }

  async function saveMember(){
    const id=document.getElementById('editId').value;
    const data={name:document.getElementById('mName').value.trim(),
                phone:document.getElementById('mPhone').value.trim()};
    if(!data.name) return alert('Name required');
    try{
      id? await db.collection('members').doc(id).update(data)
        : await db.collection('members').add(data);
      bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
      loadData();
    }catch(e){alert('Save error: '+e.message);}
  }

  async function deleteMember(id){
    if(confirm('Delete member?')){
      try{ await db.collection('members').doc(id).delete(); loadData(); }
      catch(e){alert('Delete error: '+e.message);}
    }
  }

  function showSavingForm(){ document.getElementById('savingForm').classList.remove('hidden'); }
  function hideSavingForm(){ document.getElementById('savingForm').classList.add('hidden'); }
  async function saveSaving(){
    const memberId=document.getElementById('sMember').value;
    const month=document.getElementById('sMonth').value;
    const amount=parseFloat(document.getElementById('sAmount').value);
    if(!memberId||!month||isNaN(amount)||amount<=0) return alert('Fill valid data');
    try{
      await db.collection('savings').add({memberId,month,amount});
      hideSavingForm(); document.getElementById('sAmount').value=''; loadData();
    }catch(e){alert('Save error: '+e.message);}
  }

  function showLoanForm(){ document.getElementById('loanForm').classList.remove('hidden'); }
  function hideLoanForm(){ document.getElementById('loanForm').classList.add('hidden'); }
  async function saveLoan(){
    const memberId=document.getElementById('lMember').value;
    const principal=parseFloat(document.getElementById('lPrincipal').value);
    const rate=parseFloat(document.getElementById('lRate').value);
    const start=document.getElementById('lStart').value;
    if(!memberId||isNaN(principal)||principal<=0||isNaN(rate)||rate<=0||!start) return alert('Fill valid data');
    try{
      await db.collection('loans').add({memberId,principal,rate,startDate:start,status:'active'});
      hideLoanForm(); loadData();
    }catch(e){alert('Save error: '+e.message);}
  }

  async function payInterest(){
    const now=new Date();
    const cur=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const due=[];
    let total=0;
    loans.filter(l=>l.status!=='closed').forEach(l=>{
      const dueMonth=getDueMonth(l.startDate);
      const paid=payments.some(p=>p.loanId===l.id && p.month===dueMonth);
      if(dueMonth===cur && !paid){
        const int=l.principal*(l.rate/100)/12;
        total+=int;
        due.push({loanId:l.id,amount:int,month:cur});
      }
    });
    if(total===0) return alert('No interest due');
    if(confirm(`Pay Rs. ${total.toFixed(2)} interest?`)){
      try{
        for(const d of due) await db.collection('payments').add(d);
        alert('Interest paid!');
        loadData();
      }catch(e){alert('Pay error: '+e.message);}
    }
  }

  function fillSelects(){
    const s=document.getElementById('sMember'), l=document.getElementById('lMember');
    s.innerHTML='<option value="">Select Member</option>';
    l.innerHTML='<option value="">Select Member</option>';
    members.forEach(m=>{ const o=`<option value="${m.id}">${m.name}</option>`; s.innerHTML+=o; l.innerHTML+=o; });
    const now=new Date();
    document.getElementById('sMonth').value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }

  // Bootstrap JS
  const bs=document.createElement('script');
  bs.src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
  document.body.appendChild(bs);
</script>

</body>
</html>
