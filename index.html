<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thaleshwor Yuwa Samuh</title>

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

  <style>
    :root { --primary:#0d6efd; --success:#198754; --danger:#dc3545; --warning:#ffc107; }
    body { background:#f4f6f9; font-family:'Segoe UI',sans-serif; }
    .card { border:none; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.07); transition:transform .2s; }
    .card:hover { transform:translateY(-4px); }
    .card-header { border-radius:12px 12px 0 0; font-weight:600; }
    .btn { border-radius:8px; }
    .navbar { box-shadow:0 2px 8px rgba(0,0,0,.1); }
    .stat-card { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; }
    .stat-card .card-body h5 { font-size:1rem; opacity:.9; }
    .stat-card .card-body p { font-size:1.8rem; font-weight:700; }
    .hidden { display:none !important; }
    .defaulter { color:var(--danger); font-weight:500; }
    .modal-content { border-radius:12px; }
    #errorMsg { background:#ffebee; color:#c62828; padding:12px; border-radius:8px; margin-top:1rem; }
    .chart-container { position:relative; height:280px; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="bi bi-bank"></i> Thaleshwor Yuwa Samuh</a>
    <span class="navbar-text ms-auto" id="userRole"></span>
    <button class="btn btn-outline-light ms-3" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container mt-4">

  <!-- ==================== LOGIN ==================== -->
  <div id="loginSection" class="card mx-auto p-4" style="max-width:420px;">
    <h3 class="text-center mb-4"><i class="bi bi-box-arrow-in-right"></i> Login</h3>
    <div class="mb-3">
      <label class="form-label">Username</label>
      <input id="username" class="form-control" placeholder="admin or user">
    </div>
    <div class="mb-3">
      <label class="form-label">Password</label>
      <input id="password" type="password" class="form-control">
    </div>
    <button onclick="login()" class="btn btn-primary w-100">Login</button>
    <p id="loginMsg" class="text-danger text-center mt-2"></p>
  </div>

  <!-- ==================== MAIN APP ==================== -->
  <div id="appSection" class="hidden">

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-md-3"><div class="card stat-card"><div class="card-body text-center"><h5>Members</h5><p id="totalMembers">0</p></div></div></div>
      <div class="col-md-3"><div class="card stat-card"><div class="card-body text-center"><h5>Total Saving</h5><p id="totalSaving">0</p></div></div></div>
      <div class="col-md-3"><div class="card stat-card"><div class="card-body text-center"><h5>Total Loan</h5><p id="totalLoan">0</p></div></div></div>
      <div class="col-md-3"><div class="card stat-card"><div class="card-body text-center"><h5>Growth %</h5><p id="growthRate">0</p></div></div></div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-success text-white"><i class="bi bi-graph-up"></i> Savings (Last 6 Months)</div>
          <div class="card-body"><div class="chart-container"><canvas id="savingChart"></canvas></div></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header bg-warning text-dark"><i class="bi bi-pie-chart"></i> Loan Distribution</div>
          <div class="card-body"><div class="chart-container"><canvas id="loanPie"></canvas></div></div>
        </div>
      </div>
    </div>

    <!-- Defaulters -->
    <div class="card mb-4">
      <div class="card-header bg-danger text-white"><i class="bi bi-exclamation-triangle"></i> Defaulters (Current Month)</div>
      <div class="card-body" id="defaulters"></div>
    </div>

    <!-- Admin Buttons -->
    <div id="adminControls" class="hidden mb-4">
      <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#memberModal"><i class="bi bi-person-plus"></i> Add Member</button>
      <button class="btn btn-info me-2" onclick="showSavingForm()"><i class="bi bi-piggy-bank"></i> Add Saving</button>
      <button class="btn btn-warning me-2" onclick="showLoanForm()"><i class="bi bi-cash-stack"></i> Add Loan</button>
      <button class="btn btn-danger me-2" onclick="payInterest()"><i class="bi bi-currency-exchange"></i> Pay Interest</button>
    </div>

    <!-- Members Table -->
    <div class="card">
      <div class="card-header bg-primary text-white"><i class="bi bi-people"></i> Members</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light"><tr><th>Name</th><th>Phone</th><th>Saving</th><th>Loan</th><th class="text-end">Action</th></tr></thead>
            <tbody id="memberTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <p id="errorMsg" class="hidden"></p>
</div>

<!-- ==================== MODALS ==================== -->
<div class="modal fade" id="memberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5><i class="bi bi-person"></i> Member</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="editId">
        <div class="mb-3"><label class="form-label">Name</label><input id="mName" class="form-control"></div>
        <div class="mb-3"><label class="form-label">Phone</label><input id="mPhone" class="form-control"></div>
      </div>
      <div class="modal-footer"><button class="btn btn-primary" onclick="saveMember()">Save</button></div>
    </div>
  </div>
</div>

<div id="savingForm" class="hidden card mt-4">
  <div class="card-header bg-info text-white"><i class="bi bi-piggy-bank"></i> Add Monthly Saving</div>
  <div class="card-body">
    <select id="sMember" class="form-select mb-3"></select>
    <input type="month" id="sMonth" class="form-control mb-3">
    <input type="number" id="sAmount" class="form-control mb-3" placeholder="Amount">
    <button class="btn btn-success me-2" onclick="saveSaving()">Save</button>
    <button class="btn btn-secondary" onclick="hideSavingForm()">Cancel</button>
  </div>
</div>

<div id="loanForm" class="hidden card mt-4">
  <div class="card-header bg-warning text-dark"><i class="bi bi-cash-stack"></i> Add Loan</div>
  <div class="card-body">
    <select id="lMember" class="form-select mb-3"></select>
    <input type="number" id="lPrincipal" class="form-control mb-3" placeholder="Principal">
    <input type="number" step="0.01" id="lRate" class="form-control mb-3" placeholder="Annual Rate %">
    <input type="date" id="lStart" class="form-control mb-3">
    <button class="btn btn-success me-2" onclick="saveLoan()">Save</button>
    <button class="btn btn-secondary" onclick="hideLoanForm()">Cancel</button>
  </div>
</div>

<script>
  // ---------- YOUR FIREBASE CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBSTXmDJTX5DyO85KR62Rcx4zzlLPP7_u0",
    authDomain: "thaleshwor-yuwa-samuh.firebaseapp.com",
    projectId: "thaleshwor-yuwa-samuh",
    storageBucket: "thaleshwor-yuwa-samuh.firebasestorage.app",
    messagingSenderId: "372716860859",
    appId: "1:372716860859:web:40de331870a5e4de5b409e",
    measurementId: "G-SPEN77HFE2"
  };
  // -----------------------------------------

  let db;
  try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); }
  catch (e) { showError('Firebase init failed: ' + e.message); }

  let isAdmin = false;
  let members = [], savings = [], loans = [], payments = [];

  function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    if (u === 'admin' && p === 'samuh2082') { isAdmin = true; startApp(); }
    else if (u === 'user' && p === 'password') { isAdmin = false; startApp(); }
    else document.getElementById('loginMsg').textContent = 'Wrong credentials';
  }

  function startApp() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('appSection').classList.remove('hidden');
    document.getElementById('adminControls').classList.toggle('hidden', !isAdmin);
    document.getElementById('userRole').textContent = isAdmin ? 'Admin' : 'Viewer';
    if (db) loadData(); else showError('Database not ready');
  }

  function logout() {
    document.getElementById('appSection').classList.add('hidden');
    document.getElementById('loginSection').classList.remove('hidden');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg; el.classList.remove('hidden');
  }

  async function loadData() {
    try {
      const [m,s,l,p] = await Promise.all([
        db.collection('members').get(),
        db.collection('savings').get(),
        db.collection('loans').get(),
        db.collection('payments').get()
      ]);
      members = m.docs.map(d=>({id:d.id,...d.data()}));
      savings = s.docs.map(d=>({id:d.id,...d.data()}));
      loans   = l.docs.map(d=>({id:d.id,...d.data()}));
      payments= p.docs.map(d=>({id:d.id,...d.data()}));
      renderAll();
    } catch (e) { showError('Load error: '+e.message); }
  }

  function renderAll() { renderMembers(); renderDashboard(); renderCharts(); renderDefaulters(); fillSelects(); }

  function renderMembers() {
    const tbody = document.getElementById('memberTable');
    tbody.innerHTML = '';
    members.forEach(m=>{
      const sav = savings.filter(x=>x.memberId===m.id).reduce((a,b)=>a+b.amount,0);
      const ln  = loans.filter(x=>x.memberId===m.id && x.status!=='closed').reduce((a,b)=>a+b.principal,0);
      tbody.innerHTML += `<tr>
        <td>${m.name}</td><td>${m.phone}</td><td>${sav.toFixed(2)}</td><td>${ln.toFixed(2)}</td>
        <td class="text-end">
          ${isAdmin?`<button class="btn btn-sm btn-outline-primary" onclick="editMember('${m.id}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteMember('${m.id}')"><i class="bi bi-trash"></i></button>`:''}
        </td>
      </tr>`;
    });
  }

  function renderDashboard() {
    const totalM = members.length;
    const totalS = savings.reduce((a,b)=>a+b.amount,0);
    const totalL = loans.filter(x=>x.status!=='closed').reduce((a,b)=>a+b.principal,0);
    const growth = calculateGrowth();
    document.getElementById('totalMembers').textContent = totalM;
    document.getElementById('totalSaving').textContent   = totalS.toFixed(2);
    document.getElementById('totalLoan').textContent     = totalL.toFixed(2);
    document.getElementById('growthRate').textContent    = growth.toFixed(2)+'%';
  }

  function calculateGrowth() {
    const now = new Date();
    const cur = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const prev= `${now.getFullYear()}-${String(now.getMonth()).padStart(2,'0')}`;
    const curSav = savings.filter(x=>x.month===cur).reduce((a,b)=>a+b.amount,0);
    const prevSav= savings.filter(x=>x.month===prev).reduce((a,b)=>a+b.amount,0);
    return prevSav===0?0:((curSav-prevSav)/prevSav)*100;
  }

  let savingChart, loanPie;
  function renderCharts() {
    // Line chart – last 6 months
    const months=[], data=[];
    for(let i=5;i>=0;i--){
      const d=new Date(); d.setMonth(d.getMonth()-i);
      const m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      months.push(m);
      data.push(savings.filter(x=>x.month===m).reduce((a,b)=>a+b.amount,0));
    }
    if(savingChart) savingChart.destroy();
    savingChart = new Chart(document.getElementById('savingChart'),{
      type:'line',
      data:{labels:months,datasets:[{label:'Savings',data,borderColor:'#198754',backgroundColor:'rgba(25,135,84,.1)',fill:true}]},
      options:{responsive:true,plugins:{legend:{display:false}}}
    });

    // Pie chart – loan distribution
    const labels=[], vals=[];
    members.forEach(m=>{
      const amt=loans.filter(x=>x.memberId===m.id && x.status!=='closed').reduce((a,b)=>a+b.principal,0);
      if(amt>0){labels.push(m.name); vals.push(amt);}
    });
    if(loanPie) loanPie.destroy();
    loanPie = new Chart(document.getElementById('loanPie'),{
      type:'doughnut',
      data:{labels,datasets:[{data:vals,backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF']}]},
      options:{responsive:true,plugins:{legend:{position:'bottom'}}}
    });
  }

  function renderDefaulters() {
    const now=new Date();
    const cur=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    let html=`<h6 class="text-danger"><i class="bi bi-exclamation-circle"></i> Saving Defaulters</h6><ul class="list-unstyled">`;
    members.forEach(m=>{ if(!savings.some(x=>x.memberId===m.id && x.month===cur)) html+=`<li class="defaulter"><i class="bi bi-person-x"></i> ${m.name}</li>`; });
    html+=`</ul><h6 class="text-danger"><i class="bi bi-cash-coin"></i> Interest Defaulters</h6><ul class="list-unstyled">`;
    loans.filter(l=>l.status!=='closed').forEach(l=>{
      const mem=members.find(m=>m.id===l.memberId);
      if(!mem) return;
      const dueMonth = getDueMonth(l.startDate);
      const paid = payments.some(p=>p.loanId===l.id && p.month===dueMonth);
      if(dueMonth===cur && !paid) html+=`<li class="defaulter"><i class="bi bi-currency-exchange"></i> ${mem.name}</li>`;
    });
    html+=`</ul>`;
    document.getElementById('defaulters').innerHTML = html || '<p class="text-success">No defaulters this month.</p>';
  }

  function getDueMonth(start){
    return `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`; // current month
  }

  // ---------- ADMIN ----------
  function editMember(id){
    const m=members.find(x=>x.id===id);
    document.getElementById('editId').value=id;
    document.getElementById('mName').value=m.name;
    document.getElementById('mPhone').value=m.phone;
    new bootstrap.Modal(document.getElementById('memberModal')).show();
  }

  async function saveMember(){
    const id=document.getElementById('editId').value;
    const data={name:document.getElementById('mName').value.trim(), phone:document.getElementById('mPhone').value.trim()};
    if(!data.name) return alert('Name required');
    try{
      id?await db.collection('members').doc(id).update(data):await db.collection('members').add(data);
      bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
      loadData();
    }catch(e){alert('Save error: '+e.message);}
  }

  async function deleteMember(id){
    if(confirm('Delete this member?')){ try{await db.collection('members').doc(id).delete(); loadData();}catch(e){alert(e.message);} }
  }

  function showSavingForm(){ document.getElementById('savingForm').classList.remove('hidden'); }
  function hideSavingForm(){ document.getElementById('savingForm').classList.add('hidden'); }
  async function saveSaving(){
    const memberId=document.getElementById('sMember').value;
    const month=document.getElementById('sMonth').value;
    const amount=parseFloat(document.getElementById('sAmount').value);
    if(!memberId||!month||isNaN(amount)||amount<=0) return alert('Fill all fields correctly');
    try{
      await db.collection('savings').add({memberId,month,amount});
      hideSavingForm(); document.getElementById('sAmount').value=''; loadData();
    }catch(e){alert(e.message);}
  }

  function showLoanForm(){ document.getElementById('loanForm').classList.remove('hidden'); }
  function hideLoanForm(){ document.getElementById('loanForm').classList.add('hidden'); }
  async function saveLoan(){
    const memberId=document.getElementById('lMember').value;
    const principal=parseFloat(document.getElementById('lPrincipal').value);
    const rate=parseFloat(document.getElementById('lRate').value);
    const start=document.getElementById('lStart').value;
    if(!memberId||isNaN(principal)||principal<=0||isNaN(rate)||rate<=0||!start) return alert('Fill all fields correctly');
    try{
      await db.collection('loans').add({memberId,principal,rate,startDate:start,status:'active'});
      hideLoanForm(); loadData();
    }catch(e){alert(e.message);}
  }

  async function payInterest(){
    const now=new Date();
    const cur=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const due=[];
    let total=0;
    loans.filter(l=>l.status!=='closed').forEach(l=>{
      const dueMonth=getDueMonth(l.startDate);
      const paid=payments.some(p=>p.loanId===l.id && p.month===dueMonth);
      if(dueMonth===cur && !paid){
        const int=l.principal*(l.rate/100)/12;
        total+=int;
        due.push({loanId:l.id,amount:int,month:cur});
      }
    });
    if(total===0) return alert('No interest due this month');
    if(confirm(`Pay Rs. ${total.toFixed(2)} interest?`)){
      try{
        for(const d of due) await db.collection('payments').add(d);
        alert('Interest paid successfully!');
        loadData();
      }catch(e){alert(e.message);}
    }
  }

  function fillSelects(){
    const s=document.getElementById('sMember'), l=document.getElementById('lMember');
    s.innerHTML='<option value="">Select Member</option>';
    l.innerHTML='<option value="">Select Member</option>';
    members.forEach(m=>{ const o=`<option value="${m.id}">${m.name}</option>`; s.innerHTML+=o; l.innerHTML+=o; });
    const now=new Date();
    document.getElementById('sMonth').value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }

  // Bootstrap JS
  const bs=document.createElement('script');
  bs.src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
  document.body.appendChild(bs);
</script>

</body>
</html>
